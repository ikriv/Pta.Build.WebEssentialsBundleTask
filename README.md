Pta.Build.WebEssentialsBundleTask
=================================

**MSBUILD task for expanding *Web Essentials* CSS and JavaScript bundles in HTML files**

Using *Web Essentials* CSS and JavaScript bundle files?  
Referencing those bundles in plain HTML files?  
Want the same behavior as the ASP.NET Optimization framework?  

Quick start
-----------
1. Install the *NuGet* package to your project:

	`Install-Package Pta.Build.WebEssentialsBundleTask`

2. Create one or more *Web Essentials* CSS and JavaScript bundle files.
3. Reference the bundles in your HTML files, for example:

	`!!styles: /css/app!!`
	`!!scripts: /js/vendor!!`
	`!!scripts: /js/app!!`

4. Build your project.

Documentation
-------------

### Bundle files

Creating *Web Essentials* CSS and JavaScript bundles will create files with extension *.css.bundle*
or *.js.bundle*. These are XML files containing references to CSS and JavaScript resources.

*Web Essentials* will automatically generate and update the vanilla and minified version
of the bundle resource file.

In HTML, you reference the bundle as a vanilla, non-minified, CSS and JavaScript resource file:

		<link rel="stylesheet" href="/css/app.css">
		<script src="/js/vendor.js"></script>
		<script src="/js/app.js"></script>

and the minified version as:

		<link rel="stylesheet" href="/css/app.min.css">
		<script src="/js/vendor.min.js"></script>`
		<script src="/js/app.min.js"></script>`

There are 3 problems with this approach:

1.	The bundle will not expand to the individual resource files in debug builds.
2.	The bundle will not switch between the minified version in release builds and the vanilla, non-minified, version in debug builds.
3.	The bundle will not automatically invalidate the browsers cache if the resources changes.

### Using the *NuGet* package

The *NuGet* package adds a build task to the project. This task will scan all HTML files in the project
for bundle references. When a bundle reference is found, the bundle reference is replaced by references
to the actual resource files.

For example:

		!!scripts: /js/app!!

will be replaced with:

	    <!--begin-scripts: /js/app-->
	    <script src='/js/app.min.js?_v=140ff438eaaede'></script>
	    <!--end-scripts: /js/app-->

or:

	    <!--begin-scripts: /js/app-->
	    <script src='/js/app/main.js?_v=c3506a667e0dc5'></script>
	    <script src='/js/app/dataService.js?_v=79c103a8992298'></script>
	    <script src='/js/app/homeController.js?_v=f57f92c89eb3d8'></script>
	    <!--end-scripts: /js/app-->

depending on the build configuration. The former one is a release build, the later one a debug build.

Things to note:

*	The release build references the minified version of the resource generated by *Web Essentials*.	
	You can disable minification by setting the minify flag in the bundle file to false.
*	The debug build references all resources in the bundle separately.
*	The debug build references the vanilla, non-minified, resources.
*	A version query is added to the resource reference.

### The build task

The build task will run as early as possible in the build process so the HTML output can be processed further by other build tasks. For instance they can be add

The task is define as:

		<Target Name="WebEssentialsBundle">
			<ItemGroup>
				<Bundles Include="@(Content);@(EmbeddedResource)" Condition="'%(Extension)' == '.bundle'" />
				<HtmlFiles Include="@(Content);@(EmbeddedResource)" Condition="'%(Extension)' == '.html'" />
			</ItemGroup>

			<WebEssentialsBundleTask Configuration="$(Configuration)" ProjectDir="$(ProjectDir)"
				Bundles="@(Bundles)" HtmlFiles="@(HtmlFiles)" DebugConfiguration="$(BundleDebugConfiguration)"
				WebRootDir="$(BundleWebRootDir)" AddVersionQuery="$(BundleAddVersionQuery)" />
		</Target>

and the default properties are:

		<PropertyGroup>
			<BundleDebugConfiguration>Debug</BundleDebugConfiguration>
			<BundleWebRootDir></BundleWebRootDir>
			<BundleAddVersionQuery>true</BundleAddVersionQuery>
		</PropertyGroup>

Things to note:

*	The build task only recognizes  bundle and HTML files that are marked as *Content* or *EmbeddedResource* **Build Actions** in the project.

### Customizing the build task

There are 3 levels of customization:

1. Solution
2. Project
3. Bundle

#### Solution level customization

Edit the package file *Pta.Build.WebEssentialsBundleTask.props*. The file
can be found in the package folder `packages\Pta.Build.WebEssentialsBundleTask.1.0.1\build`.

Property `BundleDebugConfiguration`	specifies the build configuration name to be recognized as
the debug build, all other configurations will be treated as release builds.

Property `BundleAddVersionQuery` specifies if a version query string should be added to each
resource file URL.

Property `BundleWebRootDir` specifies the web root directory used to calculate the resource URLs.
The directory should  be a subdirectory of the project. For example if the project directory is
`D:\Dev\Project1` and `BundleWebRootDir` is set to `Web` then `D:\Dev\Project1\Web` is used as
the web root to calculate the (relative) resource URLs.

#### Project level customization

Add the `PropertyGroup` from the package *Pta.Build.WebEssentialsBundleTask.props* file to the
project file (`.csproj` or `.vbproj`). Project properties override package properties.

#### Bundle level custiomization

Add an `addVersionQuery` element to the `settings` section in the bundle file:

		<settings>
			<addVersionQuery>true</addVersionQuery>
		</settings>

Bundle settings override project and solution properties.

### Not supported

* *Web Essentials* HTML and sprite bundles.
* The `outputDirectory` setting in bundle files (also not implemented by *Web Essentials 2013*).

Roadmap
-------

* Support for `outputDirectory` setting in bundle files.
* Support for wildcards in file references in the bundle file. For example: `/js/app/**/*.js`.
* Support for HTML bundles
* *Visual Studio* extension:
		+ configure / customize settings
		+ revert bundle reference (aka undo bundle expansions)

Please note that some items will also result in pull requests for *Web Essentials*.

License
-------

[MIT](https://github.com/ptakes/Pta.Build.WebEssentialsBundleTask/blob/master/LICENSE)
